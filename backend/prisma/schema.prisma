// Trackd - Database Schema
// Based on PRD v1.0 Data Models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// User Model (PRD Section 8.1)
// ============================================
model User {
  id           String   @id @default(cuid())
  username     String   @unique // lowercase, unique
  displayName  String
  email        String   @unique
  bio          String?
  avatarUrl    String?
  isArtist     Boolean  @default(false)
  artistName   String?

  // Spotify OAuth (required for all users - Spotify-only auth)
  spotifyId           String    @unique
  spotifyAccessToken  String    // Encrypted access token
  spotifyRefreshToken String    // Encrypted refresh token
  spotifyTokenExpiry  DateTime  // When access token expires
  spotifyPremium      Boolean   @default(false) // For Web Playback SDK

  // Avatar selection
  avatarType    AvatarType @default(custom)
  pixelAvatarId Int?       // 1-5 for predefined pixel avatars

  // Streaming profile links (JSON object)
  streamingLinks Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  posts              Post[]
  comments           Comment[]
  playlists          Playlist[]
  upvotes            Upvote[]
  notifications      Notification[]       @relation("NotificationRecipient")
  actorNotifications Notification[]       @relation("NotificationActor")
  reputations        Reputation[]
  memberships        CommunityMembership[]
  createdCommunities Community[]

  // Follow relations
  following Follow[] @relation("Follower")
  followers Follow[] @relation("Following")

  // Saved posts
  savedPosts SavedPost[]

  // New relations for music logging platform
  reviews          Review[]
  reviewComments   ReviewComment[]
  ratings          Rating[]
  playlistPreviews PlaylistPreview[]
  albumTagsAdded   AlbumTag[]        @relation("AlbumTagAdder")

  @@index([username])
  @@index([email])
}

enum AvatarType {
  custom // User-uploaded
  pixel  // Predefined pixel art
}

// ============================================
// Post Model (PRD Section 8.2)
// ============================================
model Post {
  id               String    @id @default(cuid())
  authorId         String
  content          String    @db.VarChar(2000) // max 2000 chars
  linkUrl          String?
  linkType         LinkType?
  tags             String[]  // community tags, genre tags
  upvoteCount      Int       @default(0)
  commentCount     Int       @default(0)
  isNewAndUpcoming Boolean   @default(false) // #NewAndUpcoming tag
  postType         PostType  @default(discussion) // discussion or music

  // Cached link metadata (title, artist, coverArt from URL parsing)
  linkMetadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments Comment[]
  upvotes  Upvote[]  @relation("PostUpvotes")
  savedBy  SavedPost[]

  // Community tags (many-to-many)
  communities PostCommunity[]

  // Structured tags (many-to-many with Tag model)
  postTags PostTag[]

  @@index([authorId])
  @@index([createdAt])
  @@index([isNewAndUpcoming])
}

enum LinkType {
  track
  album
  playlist
}

enum PostType {
  discussion
  music
}

// ============================================
// Community Model (PRD Section 8.3)
// ============================================
model Community {
  id            String @id @default(cuid())
  slug          String @unique // unique identifier
  name          String
  description   String?
  rules         String?
  coverImageUrl String?
  creatorId     String
  memberCount   Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creator     User                  @relation(fields: [creatorId], references: [id])
  members     CommunityMembership[]
  posts       PostCommunity[]
  reputations Reputation[]

  @@index([slug])
}

// ============================================
// Comment Model (PRD Section 8.4)
// ============================================
model Comment {
  id              String  @id @default(cuid())
  postId          String
  authorId        String
  parentCommentId String? // for threading
  content         String  @db.VarChar(1000) // max 1000 chars
  upvoteCount     Int     @default(0)
  depth           Int     @default(0) // Nesting level for threaded display

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  post          Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author        User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parentComment Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies       Comment[] @relation("CommentReplies")
  upvotes       Upvote[]  @relation("CommentUpvotes")

  @@index([postId])
  @@index([authorId])
  @@index([parentCommentId])
}

// ============================================
// Reputation Model (PRD Section 8.5)
// ============================================
model Reputation {
  id          String         @id @default(cuid())
  userId      String
  communityId String
  score       Int            @default(0)
  tier        ReputationTier @default(newcomer)

  updatedAt DateTime @updatedAt

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
}

enum ReputationTier {
  newcomer  // 0-99
  regular   // 100-499
  trusted   // 500-999
  curator   // 1000+
}

// ============================================
// Follow Model (PRD Section 8.6)
// ============================================
model Follow {
  id          String @id @default(cuid())
  followerId  String
  followingId String

  createdAt DateTime @default(now())

  // Relations
  follower  User @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============================================
// CommunityMembership Model (PRD Section 8.7)
// ============================================
model CommunityMembership {
  id          String         @id @default(cuid())
  userId      String
  communityId String
  role        MembershipRole @default(member)

  joinedAt DateTime @default(now())

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
}

enum MembershipRole {
  member
  moderator
  creator
}

// ============================================
// Playlist Models (PRD Section 8.8)
// ============================================
model Playlist {
  id            String  @id @default(cuid())
  ownerId       String
  name          String
  description   String?
  coverImageUrl String?
  isPublic      Boolean @default(true)
  trackCount    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  owner  User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tracks PlaylistTrack[]

  @@index([ownerId])
}

model PlaylistTrack {
  id         String @id @default(cuid())
  playlistId String
  linkUrl    String
  title      String
  artist     String
  position   Int

  addedAt DateTime @default(now())

  // Relations
  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)

  @@index([playlistId])
}

// ============================================
// Upvote Model (PRD Section 8.9)
// ============================================
model Upvote {
  id         String     @id @default(cuid())
  userId     String
  targetType TargetType
  targetId   String

  createdAt DateTime @default(now())

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  post          Post?          @relation("PostUpvotes", fields: [targetId], references: [id], map: "upvote_post_fk")
  comment       Comment?       @relation("CommentUpvotes", fields: [targetId], references: [id], map: "upvote_comment_fk")
  review        Review?        @relation("ReviewUpvotes", fields: [targetId], references: [id], map: "upvote_review_fk")
  reviewComment ReviewComment? @relation("ReviewCommentUpvotes", fields: [targetId], references: [id], map: "upvote_review_comment_fk")

  @@unique([userId, targetType, targetId])
  @@index([userId])
  @@index([targetType, targetId])
}

enum TargetType {
  post
  comment
  review
  review_comment
}

// ============================================
// Notification Model (PRD Section 8.10)
// ============================================
model Notification {
  id         String           @id @default(cuid())
  userId     String           // recipient
  type       NotificationType
  actorId    String           // user who triggered
  targetType String
  targetId   String
  isRead     Boolean          @default(false)

  createdAt DateTime @default(now())

  // Relations
  user  User @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  actor User @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  follow
  upvote_post
  upvote_comment
  comment
  reply
  mention
  upvote_review
  review_comment
  review_reply
}

// ============================================
// Junction Tables
// ============================================

// Post-Community many-to-many
model PostCommunity {
  id          String @id @default(cuid())
  postId      String
  communityId String

  // Relations
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([postId, communityId])
  @@index([postId])
  @@index([communityId])
}

// Saved Posts
model SavedPost {
  id     String @id @default(cuid())
  userId String
  postId String

  savedAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
}

// ============================================
// Artist Model - Lazily created from Spotify
// ============================================
model Artist {
  id        String   @id @default(cuid())
  spotifyId String?  @unique // Nullable for manual entries
  name      String
  sortName  String?
  imageUrl  String?
  country   String?
  type      String?  // Person, Group, Orchestra, etc.
  genres    String[] // Spotify provides genres
  popularity Int?    // 0-100 Spotify popularity score
  spotifyUri String? // spotify:artist:xxx
  spotifyUrl String? // https://open.spotify.com/artist/xxx
  metadata  Json     @default("{}")

  // Aggregated stats
  reviewCount Int @default(0)
  ratingSum   Int @default(0)
  ratingCount Int @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastFetchedAt DateTime @default(now())

  // Relations
  albums  Album[]
  reviews Review[] @relation("ArtistReviews")

  @@index([name])
  @@index([spotifyId])
}

// ============================================
// Album Model - Lazily created from Spotify
// ============================================
model Album {
  id            String    @id @default(cuid())
  spotifyId     String?   @unique // Nullable for manual entries
  title         String
  artistName    String
  artistId      String?
  releaseDate   DateTime?
  releaseYear   Int?
  coverImageUrl String?
  trackCount    Int?
  albumType     String    @default("album") // album, single, ep, compilation, etc.
  spotifyUri    String?   // spotify:album:xxx
  spotifyUrl    String?   // https://open.spotify.com/album/xxx
  popularity    Int?      // 0-100 Spotify popularity score
  metadata      Json      @default("{}")

  // Aggregated stats
  reviewCount Int @default(0)
  ratingSum   Int @default(0)
  ratingCount Int @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastFetchedAt DateTime @default(now())

  // Relations
  artist  Artist?    @relation(fields: [artistId], references: [id])
  reviews Review[]   @relation("AlbumReviews")
  ratings Rating[]   @relation("AlbumRatings")
  tracks  Track[]
  tags    AlbumTag[]

  @@index([title])
  @@index([artistId])
  @@index([spotifyId])
  @@index([releaseYear])
}

// ============================================
// Track Model - For album tracklists
// ============================================
model Track {
  id          String  @id @default(cuid())
  spotifyId   String? @unique // Nullable for manual entries
  title       String
  albumId     String?
  artistName  String
  trackNumber Int?
  discNumber  Int?    @default(1)
  durationMs  Int?
  previewUrl  String? // 30-sec preview URL from Spotify
  explicit    Boolean @default(false)
  isrc        String? // International Standard Recording Code
  spotifyUri  String? // spotify:track:xxx
  spotifyUrl  String? // https://open.spotify.com/track/xxx
  popularity  Int?    // 0-100 Spotify popularity score

  createdAt DateTime @default(now())

  // Relations
  album   Album?   @relation(fields: [albumId], references: [id], onDelete: SetNull)
  reviews Review[] @relation("TrackReviews")
  ratings Rating[] @relation("TrackRatings")

  @@index([albumId])
  @@index([spotifyId])
}

// ============================================
// Review Model - Full reviews with optional rating
// ============================================
model Review {
  id         String           @id @default(cuid())
  authorId   String
  targetType ReviewTargetType
  albumId    String?
  trackId    String?
  artistId   String?

  rating  Int?    // 1-5 stars (optional - can just rate without text)
  title   String? @db.VarChar(200)
  content String? @db.VarChar(5000) // optional - can rate without review

  upvoteCount  Int @default(0)
  commentCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author   User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  album    Album?          @relation("AlbumReviews", fields: [albumId], references: [id], onDelete: Cascade)
  track    Track?          @relation("TrackReviews", fields: [trackId], references: [id], onDelete: Cascade)
  artist   Artist?         @relation("ArtistReviews", fields: [artistId], references: [id], onDelete: Cascade)
  comments ReviewComment[]
  upvotes  Upvote[]        @relation("ReviewUpvotes")

  @@unique([authorId, albumId])
  @@unique([authorId, trackId])
  @@unique([authorId, artistId])
  @@index([authorId])
  @@index([albumId])
  @@index([trackId])
  @@index([artistId])
  @@index([createdAt])
  @@index([upvoteCount])
}

enum ReviewTargetType {
  album
  track
  artist
}

// ============================================
// ReviewComment Model - Threaded comments on reviews
// ============================================
model ReviewComment {
  id          String @id @default(cuid())
  reviewId    String
  authorId    String
  parentId    String? // For threading
  content     String  @db.VarChar(2000)
  upvoteCount Int     @default(0)
  depth       Int     @default(0) // Nesting level for display

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  review  Review          @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  author  User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent  ReviewComment?  @relation("ReviewCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies ReviewComment[] @relation("ReviewCommentReplies")
  upvotes Upvote[]        @relation("ReviewCommentUpvotes")

  @@index([reviewId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
}

// ============================================
// Rating Model - Quick 5-star ratings without review
// ============================================
model Rating {
  id      String  @id @default(cuid())
  userId  String
  value   Int // 1-5 stars
  albumId String?
  trackId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  album Album? @relation("AlbumRatings", fields: [albumId], references: [id], onDelete: Cascade)
  track Track? @relation("TrackRatings", fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([userId, albumId])
  @@unique([userId, trackId])
  @@index([userId])
  @@index([albumId])
  @@index([trackId])
  @@index([value])
}

// ============================================
// Tag Model - Predefined genres + user-generated
// ============================================
model Tag {
  id         String      @id @default(cuid())
  name       String      @unique
  slug       String      @unique // URL-safe version
  category   TagCategory @default(genre)
  isOfficial Boolean     @default(false) // Predefined vs user-generated
  useCount   Int         @default(0)

  createdAt DateTime @default(now())

  // Relations
  albums AlbumTag[]
  posts  PostTag[]

  @@index([slug])
  @@index([category])
  @@index([useCount])
}

enum TagCategory {
  genre     // Rock, Pop, Jazz
  mood      // Chill, Energetic
  era       // 80s, 90s
  custom    // User-generated
}

// ============================================
// AlbumTag Junction - Tags on albums
// ============================================
model AlbumTag {
  id        String  @id @default(cuid())
  albumId   String
  tagId     String
  addedById String?

  createdAt DateTime @default(now())

  // Relations
  album   Album @relation(fields: [albumId], references: [id], onDelete: Cascade)
  tag     Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)
  addedBy User? @relation("AlbumTagAdder", fields: [addedById], references: [id], onDelete: SetNull)

  @@unique([albumId, tagId])
  @@index([albumId])
  @@index([tagId])
}

// ============================================
// PostTag Junction - Tags on posts
// ============================================
model PostTag {
  id     String @id @default(cuid())
  postId String
  tagId  String

  createdAt DateTime @default(now())

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

// ============================================
// PlaylistPreview - External playlist metadata (preview only)
// ============================================
model PlaylistPreview {
  id            String         @id @default(cuid())
  userId        String // User who shared this playlist
  sourceType    PlaylistSource
  sourceUrl     String // Original Spotify/Apple Music URL
  sourceId      String // Playlist ID from source
  name          String
  description   String?
  ownerName     String? // Original playlist creator
  coverImageUrl String?
  trackCount    Int            @default(0)

  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sourceType, sourceId]) // Deduplicate by source
  @@index([userId])
}

enum PlaylistSource {
  spotify
  apple_music
  youtube_music
  soundcloud
}
